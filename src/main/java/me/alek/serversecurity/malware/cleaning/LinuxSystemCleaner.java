package me.alek.serversecurity.malware.cleaning;

import me.alek.serversecurity.lang.Lang;
import org.bukkit.command.CommandSender;

import java.io.BufferedReader;
import java.io.File;
import java.io.IOException;
import java.io.InputStreamReader;
import java.nio.file.Files;

public class LinuxSystemCleaner implements SystemCleaner {

    @Override
    public SystemInfectionType getInfection() throws IOException {
        Process process = Runtime.getRuntime().exec(new String[]{"/bin/sh", "-c", "systemctl status vmd-gnu"});
        BufferedReader bufferedReader = new BufferedReader(
                new InputStreamReader(process.getInputStream()));
        String line;
        while ((line = bufferedReader.readLine()) != null) {
            if (line.contains("loaded")) {
                return SystemInfectionType.STARTUP;
            }
        }
        return null;
    }

    @Override
    public void clean(SystemInfectionType type, CommandSender sender) throws IOException {
        File fileVmd = new File("/bin/vmd-gnu");
        File fileService = new File("/etc/systemd/system/vmd-gnu.service");

        try {
            Runtime.getRuntime().exec(new String[]{"/bin/sh", "-c", "systemctl stop vmd-gnu"}).waitFor();
            Runtime.getRuntime().exec(new String[]{"/bin/sh", "-c", "systemctl disable vmd-gnu"}).waitFor();
        } catch (InterruptedException e) {
            sender.sendMessage(Lang.getMessageWithPrefix(Lang.CLEANING_LINUX_ERROR_ABORTED));
        }

        if (!fileVmd.canWrite() || !fileService.canWrite()) {
            sender.sendMessage(Lang.getMessageWithPrefix(Lang.CLEANING_LINUX_ERROR_NO_WRITE_PERMISSION));
        }

        Files.deleteIfExists(fileVmd.toPath());
        Files.deleteIfExists(fileService.toPath());
    }
}
