package me.alek.serversecurity.malware.checks;

import me.alek.serversecurity.malware.checks.types.DetectionNode;
import me.alek.serversecurity.malware.checks.types.MalwareNode;
import me.alek.serversecurity.malware.model.result.CheckResult;
import me.alek.serversecurity.malware.CacheContainer;
import me.alek.serversecurity.malware.model.result.MalwareCheckResult;
import me.alek.serversecurity.model.PluginProperties;
import me.alek.serversecurity.utils.ZipUtils;
import org.bukkit.plugin.Plugin;
import org.objectweb.asm.tree.ClassNode;

import java.io.File;
import java.nio.file.Files;
import java.nio.file.Path;
import java.util.Iterator;
import java.util.stream.Stream;

public abstract class BaseCheck {

    public boolean resolve(Path rootFolder, String path) {
        return Files.exists(rootFolder.resolve(path));
    }

    public abstract boolean processFileInJar(Path classPath, ClassNode classNode, File file, boolean isClass);

    public abstract boolean preProcessJAR(File file, Path rootFolder, PluginProperties pluginProperties);

    public boolean isServersideCheck() {
        return false;
    }

    public CheckResult handlePreProcess(File file, Path rootFolder, PluginProperties properties) {
        if (preProcessJAR(file, rootFolder, properties)) {
            return getCheck(this);
        }
        return null;
    }

    public CheckResult handleInJar(Path classPath, ClassNode classNode, File file, boolean validClassPath) {
        if (processFileInJar(classPath, classNode, file, validClassPath)) {
            return getCheck(this);
        }
        return null;
    }

    public static CheckResult getCheck(BaseCheck handler) {
        if (handler instanceof DetectionNode) {
            DetectionNode node = (DetectionNode) handler;
            return new CheckResult(node.getType(), node.getRisk());
        }
        if (handler instanceof MalwareNode) {
            MalwareNode node = (MalwareNode) handler;
            return new MalwareCheckResult(node.getType());
        }
        return null;
    }

}
