package me.alek.antimalware.security.blocker.injector;

import me.alek.antimalware.AntiMalwarePlugin;
import me.alek.antimalware.security.SecurityManager;
import me.alek.antimalware.security.blocker.AbstractListener;
import net.minecraft.server.v1_8_R3.EntityLiving;
import org.bukkit.craftbukkit.v1_8_R3.entity.CraftPlayer;
import org.bukkit.entity.Player;
import org.bukkit.event.EventHandler;
import org.bukkit.event.EventPriority;
import org.bukkit.event.player.PlayerJoinEvent;
import org.bukkit.event.server.ServerCommandEvent;
import org.bukkit.plugin.PluginManager;
import org.bukkit.scheduler.BukkitRunnable;

import java.util.function.Supplier;

public class InjectorHandler extends AbstractListener {

    public InjectorHandler(SecurityManager manager, PluginManager pluginManager) {
        super(manager, pluginManager);
    }

    @EventHandler(priority = EventPriority.LOWEST)
    public void inject(ServerCommandEvent event) {
        tryInject();
    }

    @EventHandler
    public void inject(PlayerJoinEvent event) {
        tryInject();
    }

    private void tryInject() {
        for (InjectType type : InjectType.values()) {
            if (type.getInjector().isInjected()) {
                continue;
            }
            type.getInjector().inject();
            new BukkitRunnable() {

                @Override
                public void run() {
                    type.getInjector().reinject();
                }
            }.runTaskLaterAsynchronously(AntiMalwarePlugin.getInstance(), 36000L);
        }
    }

    private enum InjectType {
        COMMANDS(CommandInjector::new),
        LISTENERS(ListenerInjector::new);

        private final Supplier<Injector> injector;

        InjectType(Supplier<Injector> injector) {
            this.injector = injector;
        }

        public Injector getInjector() {
            return injector.get();
        }
    }
}
