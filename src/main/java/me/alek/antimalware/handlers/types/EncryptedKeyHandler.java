package me.alek.antimalware.handlers.types;

import me.alek.antimalware.helpers.BytecodeHelper;
import org.objectweb.asm.Opcodes;
import org.objectweb.asm.tree.AbstractInsnNode;
import org.objectweb.asm.tree.MethodInsnNode;
import org.objectweb.asm.tree.MethodNode;

import java.nio.file.Path;
import java.util.ArrayList;

public abstract class EncryptedKeyHandler extends AbstractInstructionHandler {

    public EncryptedKeyHandler() {
        super(MethodInsnNode.class);
    }

    @Override
    public String processAbstractInsn(MethodNode methodNode, AbstractInsnNode abstractInsnNode, Path classPath) {
        MethodInsnNode methodInsnNode = (MethodInsnNode) abstractInsnNode;
        ArrayList<String> testStrings = new ArrayList<>();
        switch (methodInsnNode.owner) {
            case "java/net/URI": {

                //WEBSOCKET URI CHECK
                if (methodInsnNode.name.equals("create")) {
                    String websocketURI = BytecodeHelper.getStringUsed(methodInsnNode);
                    if (websocketURI != null) {
                        testStrings.add(websocketURI);
                    }
                }
            }
            case "java/lang/String": {

                if (methodInsnNode.getOpcode() == Opcodes.INVOKESPECIAL) {

                    String bytesInvocation = BytecodeHelper.getBytesInvocation(methodInsnNode);
                    if (bytesInvocation != null) {
                        testStrings.add(bytesInvocation);
                    }
                }
            }
            case "java/util/Base64$Decoder": {

                String base64Invocation = BytecodeHelper.getBase64Invocation(methodInsnNode);
                if (base64Invocation != null) {
                    testStrings.add(base64Invocation);
                }
            }
        }

        for (String testString : testStrings) {
            for (String url : getEncryptedKeys()) {

                if (testString.equals(url)) {
                    if (url.contains("hostflow")) {
                        return "Websocket URI";
                    }
                    return "Key";
                }
            }
        }
        return null;
    }

    public abstract String[] getEncryptedKeys();
}
